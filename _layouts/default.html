---
layout: compress
---


<!DOCTYPE html>
<html>
{% include head.html %}
  <body>
    <div class="content" id="header">
      {% include header.html %}
    </div>
    <div class="content" id="main-content">
      <div class="content-wrapper">
        <div id="react-app">
          {{ content }}
        </div>
      </div>
    </div>
    {% include footer.html %}
    {% include syntax_highlight.html %}
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const e = React.createElement;
        const useState = React.useState;
        const useEffect = React.useEffect;

        function App() {
          const [content, setContent] = useState(document.getElementById('react-app').innerHTML);
          const [loading, setLoading] = useState(false);

          // 处理脚本执行的辅助函数
          const executeScripts = (container) => {
            const scripts = container.querySelectorAll('script');
            scripts.forEach(oldScript => {
              const newScript = document.createElement('script');
              Array.from(oldScript.attributes).forEach(attr => {
                newScript.setAttribute(attr.name, attr.value);
              });
              newScript.textContent = oldScript.textContent;
              oldScript.parentNode.replaceChild(newScript, oldScript);
            });
          };

          // 导航处理函数
          const navigate = async (url, isPopState = false) => {
            setLoading(true);
            
            const hashIndex = url.indexOf('#');
            const hash = hashIndex !== -1 ? url.substring(hashIndex) : null;
            const fetchUrl = hashIndex !== -1 ? url.substring(0, hashIndex) : url;

            // 创建滚动等待 Promise
            const scrollPromise = new Promise(resolve => {
                if (isPopState) {
                    resolve();
                    return;
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // 如果已经在顶部附近，直接完成
                if (window.scrollY < 50) {
                    resolve();
                    return;
                }

                let resolved = false;
                const finish = () => {
                    if (!resolved) {
                        resolved = true;
                        resolve();
                    }
                };

                // 超时保护 (1秒)
                setTimeout(finish, 1000);

                const checkScroll = () => {
                    if (resolved) return;
                    if (window.scrollY < 50) {
                        finish();
                    } else {
                        requestAnimationFrame(checkScroll);
                    }
                };
                requestAnimationFrame(checkScroll);
            });

            try {
              // 并行执行请求和滚动，等待两者都完成
              const [response, _] = await Promise.all([
                  fetch(fetchUrl),
                  scrollPromise
              ]);
              const html = await response.text();
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              const newContent = doc.getElementById('react-app').innerHTML;
              const title = doc.title;

              document.title = title;
              setContent(newContent);
              
              if (!isPopState) {
                window.history.pushState({}, '', url);
              }
              
              // 等待 DOM 更新后执行脚本
              setTimeout(() => {
                const container = document.getElementById('react-app');
                if (container) executeScripts(container);
                // 重新触发高亮
                if (window.hljs) window.hljs.initHighlighting.called = false; window.hljs.initHighlighting();

                if (!isPopState) {
                  if (hash) {
                    // 处理锚点跳转
                    try {
                      const id = decodeURIComponent(hash.substring(1));
                      let element = document.getElementById(id);
                      if (!element) {
                        element = document.getElementById(hash.substring(1));
                      }
                      if (element) {
                        element.scrollIntoView({ behavior: 'smooth' });
                      }
                    } catch (e) {
                      console.error('Anchor scroll failed:', e);
                    }
                  } else {
                    // 普通跳转：再次确保滚动到顶部（解决内容高度变化导致的滚动位置异常）
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                  }
                }
              }, 50);

            } catch (error) {
              console.error('Navigation failed:', error);
              // 如果 fetch 失败，回退到普通跳转
              if (!isPopState) window.location.href = url;
            } finally {
              setLoading(false);
            }
          };

          useEffect(() => {
            // 禁用浏览器默认的滚动恢复，完全由我们控制
            if ('scrollRestoration' in history) {
              history.scrollRestoration = 'manual';
            }

            // 拦截点击事件
            const handleClick = (e) => {
              const link = e.target.closest('a');
              if (!link) return;

              const href = link.getAttribute('href');
              // 排除外部链接、锚点、非 HTTP 协议
              if (!href || 
                  href.startsWith('http') && !href.startsWith(window.location.origin) ||
                  href.startsWith('#') ||
                  href.startsWith('mailto:') ||
                  link.getAttribute('target') === '_blank') {
                return;
              }

              e.preventDefault();
              navigate(href);
            };

            // 监听后退/前进
            const handlePopState = () => {
              navigate(window.location.href, true);
            };

            document.addEventListener('click', handleClick);
            window.addEventListener('popstate', handlePopState);

            return () => {
              document.removeEventListener('click', handleClick);
              window.removeEventListener('popstate', handlePopState);
            };
          }, []);

          return e('div', {
            className: `page-transition ${loading ? 'loading' : ''}`,
            dangerouslySetInnerHTML: { __html: content }
          });
        }

        const root = ReactDOM.createRoot(document.getElementById('react-app'));
        root.render(e(App));
      });
    </script>
  </body>
</html>